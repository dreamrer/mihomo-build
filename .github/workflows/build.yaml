name: Build

# ============================================================
# å…¬å…±æ„å»ºä»“åº“ï¼šä»…å« workflowï¼Œç§æœ‰æºç é€šè¿‡ PAT åœ¨ CI å†…æ‹‰å–ã€‚
#
# å¿…é¡»åœ¨æœ¬ä»“åº“ Settings â†’ Secrets and variables â†’ Actions ä¸­é…ç½®ï¼š
#   PRIVATE_REPO_TOKEN  - æœ‰ç§æœ‰ä»“åº“ read æƒé™çš„ PAT
#   BUILD_BOT_TOKEN     - TG Bot Tokenï¼ˆç”¨äºæ„å»ºå®Œæˆåå‘åŒ…ï¼Œå¯ä¸ä¸šåŠ¡ Bot å…±ç”¨ï¼‰
#
# ã€Android æ­£å¼ç­¾åï¼ˆå¯é€‰ï¼Œä¸é…ç½®åˆ™ç”¨ debug ç­¾åï¼‰ã€‘
#   KEYSTORE            - keystore.jks çš„ base64 ç¼–ç 
#   KEY_ALIAS           - keystore åˆ«å
#   STORE_PASSWORD      - keystore å¯†ç 
#   KEY_PASSWORD        - key å¯†ç 
# ============================================================

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      ref:
        description: 'ç§æœ‰ä»“åº“çš„ tag/branchï¼ˆå¦‚ v1.0.15 æˆ– mainï¼‰'
        required: true
        default: 'main'

      # â”€â”€ æ„å»ºç›®æ ‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      platforms:
        description: 'æ„å»ºå¹³å°ï¼Œé€—å·åˆ†éš”ï¼ˆandroid,windows,linux,macosï¼‰ï¼Œç•™ç©º=å…¨éƒ¨'
        required: false
        default: ''

      # â”€â”€ å“ç‰Œå®šåˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      app_name:
        description: 'App æ˜¾ç¤ºåç§°ï¼ˆç•™ç©º=ä¸ä¿®æ”¹ï¼‰'
        required: false
        default: ''
      app_logo_url:
        description: 'App Logo URLï¼ˆPNGï¼Œå»ºè®® 1024x1024ï¼Œç•™ç©º=ä¸ä¿®æ”¹ï¼‰'
        required: false
        default: ''
      app_version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¦‚ 1.2.0ï¼Œç•™ç©º=ä¸ä¿®æ”¹ï¼‰'
        required: false
        default: ''

      # â”€â”€ è¿œç¨‹é…ç½®æºï¼ˆæœ€å¤š 4 ä¸ªï¼Œä¸» + 3 ä¸ªå¤‡ç”¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      oss_url_1:
        description: 'ä¸»é…ç½®æº URLï¼ˆconfig.jsonï¼‰'
        required: false
        default: ''
      oss_url_2:
        description: 'å¤‡ç”¨é…ç½®æº 2ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      oss_url_3:
        description: 'å¤‡ç”¨é…ç½®æº 3ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      oss_url_4:
        description: 'å¤‡ç”¨é…ç½®æº 4ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      panel_type:
        description: 'panel_typeï¼ˆxboard / v2boardï¼‰'
        required: false
        default: 'xboard'

      # â”€â”€ åŠ å¯†å¯†é’¥ï¼ˆä¸ App æºç  _xorKey åŠ Bot ç”Ÿæˆè¿œç¨‹é…ç½®æ—¶ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼‰â”€â”€
      xor_key:
        description: 'XOR åŠ å¯†å¯†é’¥ï¼ˆå¿…é¡»ä¸ App ç«¯ _xorKey å®Œå…¨ä¸€è‡´ï¼Œâ‰¥16 å­—ç¬¦ï¼‰'
        required: false
        default: ''

      # â”€â”€ å®¢æœ & è”ç³»æ–¹å¼ï¼ˆå†™å…¥è¿œç¨‹é…ç½®ï¼Œä¸çƒ§å½•è¿›åŒ…ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€
      telegram_channel:
        description: 'TG æ”¯æŒé¢‘é“ï¼ˆå¦‚ https://t.me/xxxï¼Œå†™å…¥è¿œç¨‹é…ç½®å‚è€ƒï¼‰'
        required: false
        default: ''
      crisp_id:
        description: 'Crisp å®¢æœ IDï¼ˆç•™ç©º=ä¸å¯ç”¨ï¼‰'
        required: false
        default: ''

      # â”€â”€ æ„å»ºå®Œæˆé€šçŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      notify_chat_id:
        description: 'æ„å»ºå®Œæˆåå‘åŒ…çš„ TG Chat IDï¼ˆBot Token å­˜ secret BUILD_BOT_TOKENï¼‰'
        required: false
        default: ''

env:
  PRIVATE_REF: ${{ github.event_name == 'push' && github.ref_name || inputs.ref }}
  IS_STABLE: ${{ github.event_name == 'push' && !contains(github.ref, '-') || github.event_name != 'push' && !contains(inputs.ref, '-') }}

jobs:
  # â”€â”€ é¢„å¤„ç†ï¼šæ ¹æ® inputs.platforms åŠ¨æ€ç”ŸæˆçŸ©é˜µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          python3 << 'EOF'
          import json, os

          all_items = [
            {"platform": "android", "os": "ubuntu-latest"},
            {"platform": "linux",   "os": "ubuntu-latest",  "arch": "amd64"},
            {"platform": "macos",   "os": "macos-latest",   "arch": "arm64"},
            {"platform": "macos",   "os": "macos-latest",   "arch": "amd64"},
            {"platform": "windows", "os": "windows-latest", "arch": "amd64"},
          ]

          event_name   = os.environ.get("EVENT_NAME", "")
          platforms_in = os.environ.get("PLATFORMS", "").strip()

          if event_name == "push" or not platforms_in:
            filtered = all_items
          else:
            selected = {p.strip() for p in platforms_in.split(",") if p.strip()}
            filtered = [x for x in all_items if x["platform"] in selected]

          matrix = json.dumps({"include": filtered})
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"matrix={matrix}\n")
          EOF
        env:
          EVENT_NAME: ${{ github.event_name }}
          PLATFORMS:  ${{ inputs.platforms }}

  build:
    needs: setup
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      # â”€â”€ 0. é…ç½® git å‡­æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure git credentials
        run: |
          git config --global credential.helper ""
          git config --global url."https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://x-access-token:${{ secrets.PRIVATE_REPO_TOKEN }}@github.com/".insteadOf "https://github.com/"

      # â”€â”€ 1. æ‹‰å–ç§æœ‰æºç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout private source
        env:
          GIT_TERMINAL_PROMPT: "0"
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_NAME }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          submodules: recursive
          ref: ${{ env.PRIVATE_REF }}

      # â”€â”€ 2. æ³¨å…¥æ„å»ºå‚æ•°ï¼ˆä»… workflow_dispatch è§¦å‘æ—¶æ‰§è¡Œï¼‰â”€â”€â”€â”€
      - name: Inject build parameters
        if: github.event_name == 'workflow_dispatch'
        env:
          PYTHONUTF8:     "1"
          APP_NAME:       ${{ inputs.app_name }}
          APP_LOGO_URL:   ${{ inputs.app_logo_url }}
          APP_VERSION:    ${{ inputs.app_version }}
          OSS_URL_1:      ${{ inputs.oss_url_1 }}
          OSS_URL_2:      ${{ inputs.oss_url_2 }}
          OSS_URL_3:      ${{ inputs.oss_url_3 }}
          OSS_URL_4:      ${{ inputs.oss_url_4 }}
          PANEL_TYPE:     ${{ inputs.panel_type || 'xboard' }}
          XOR_KEY:        ${{ inputs.xor_key }}
        run: |
          pip install Pillow pyyaml --quiet --break-system-packages 2>/dev/null || \
          pip install Pillow pyyaml --quiet
          python3 << 'PYEOF'
          import os, re, io, urllib.request
          from pathlib import Path

          def env(k, d=''):
              return os.environ.get(k, d).strip()

          # â”€â”€ 0. æ³¨å…¥ XOR å¯†é’¥åˆ° remote_config_manager.dart â”€â”€
          xor_key = env('XOR_KEY')
          if xor_key:
              p = Path('lib/xboard/config/fetchers/remote_config_manager.dart')
              if p.exists():
                  p.write_text(re.sub(
                      r"(const String _xorKey\s*=\s*')[^']*(';)",
                      rf'\g<1>{xor_key}\g<2>', p.read_text(encoding='utf-8')
                  ), encoding='utf-8')
                  print(f'[inject] _xorKey å·²æ›´æ–°ï¼ˆé•¿åº¦ {len(xor_key)} å­—ç¬¦ï¼‰')
              else:
                  print('[inject] âš ï¸  remote_config_manager.dart æœªæ‰¾åˆ°ï¼Œè·³è¿‡ xor_key æ³¨å…¥')

          # â”€â”€ 1. ç”Ÿæˆ assets/config/config.yaml â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          sources = [{'url': env(f'OSS_URL_{i}')} for i in range(1,5) if env(f'OSS_URL_{i}')]
          if sources:
              import yaml
              cfg = {
                  'panel_type': env('PANEL_TYPE', 'xboard'),
                  'remote_config': {'sources': sources},
              }
              Path('assets/config/config.yaml').write_text(
                  yaml.dump(cfg, default_flow_style=False, allow_unicode=True)
              )
              print(f'[inject] config.yaml: {len(sources)} ä¸ªæº, panel_type={env("PANEL_TYPE")}')

          # â”€â”€ 2. æ›¿æ¢åº”ç”¨åç§° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          app_name = env('APP_NAME')
          if app_name:
              # Android strings.xml
              p = Path('android/app/src/main/res/values/strings.xml')
              if p.exists():
                  p.write_text(re.sub(
                      r'<string name="app_name">[^<]*</string>',
                      f'<string name="app_name">{app_name}</string>',
                      p.read_text()
                  ))
                  print(f'[inject] Android app_name â†’ {app_name}')
              # Windows CMakeLists.txtï¼ˆæ§åˆ¶ .exe æ–‡ä»¶åï¼Œä¸èƒ½å«ç©ºæ ¼ï¼‰
              win_binary = re.sub(r'[\s/\\:*?"<>|]+', '_', app_name)
              p = Path('windows/CMakeLists.txt')
              if p.exists():
                  p.write_text(re.sub(
                      r'set\(BINARY_NAME\s+"[^"]*"\)',
                      f'set(BINARY_NAME "{win_binary}")', p.read_text()
                  ))
                  print(f'[inject] Windows BINARY_NAME â†’ {win_binary}')
              # Windows packaging/exe/make_config.yamlï¼ˆinstaller é…ç½®ï¼Œexecutable_name å¿…é¡»ä¸ BINARY_NAME ä¸€è‡´ï¼‰
              p = Path('windows/packaging/exe/make_config.yaml')
              if p.exists():
                  import yaml as _yaml2
                  cfg = _yaml2.safe_load(p.read_text()) or {}
                  cfg['app_name'] = app_name
                  cfg['display_name'] = app_name
                  cfg['executable_name'] = f'{win_binary}.exe'
                  cfg['output_base_file_name'] = win_binary
                  p.write_text(_yaml2.dump(cfg, default_flow_style=False, allow_unicode=True))
                  print(f'[inject] Windows make_config.yaml executable_name â†’ {win_binary}.exe')
              # Windows Runner.rcï¼ˆæ–‡ä»¶å±æ€§ ProductName / FileDescriptionï¼‰
              p = Path('windows/runner/Runner.rc')
              if p.exists():
                  txt = p.read_text(encoding='utf-8', errors='replace')
                  txt = re.sub(r'VALUE "ProductName",\s*"[^"]*"',    f'VALUE "ProductName", "{app_name}"',    txt)
                  txt = re.sub(r'VALUE "FileDescription",\s*"[^"]*"', f'VALUE "FileDescription", "{app_name}"', txt)
                  p.write_text(txt, encoding='utf-8')
                  print(f'[inject] Windows ProductName â†’ {app_name}')
              # macOS Info.plist
              p = Path('macos/Runner/Info.plist')
              if p.exists():
                  p.write_text(re.sub(
                      r'(<key>CFBundleName</key>\s*<string>)[^<]*(</string>)',
                      rf'\g<1>{app_name}\g<2>', p.read_text()
                  ))
                  print(f'[inject] macOS CFBundleName â†’ {app_name}')
              # Linux CMakeLists.txt
              p = Path('linux/CMakeLists.txt')
              if p.exists():
                  p.write_text(re.sub(
                      r'set\(BINARY_NAME\s+"[^"]*"\)',
                      f'set(BINARY_NAME "{app_name}")', p.read_text()
                  ))
                  print(f'[inject] Linux BINARY_NAME â†’ {app_name}')
              # distribute_options.yamlï¼ˆæ§åˆ¶è¾“å‡ºæ–‡ä»¶åï¼‰
              p = Path('distribute_options.yaml')
              if p.exists():
                  import yaml as _yaml
                  opts = _yaml.safe_load(p.read_text()) or {}
                  opts['app_name'] = app_name
                  p.write_text(_yaml.dump(opts, default_flow_style=False, allow_unicode=True))
                  print(f'[inject] distribute_options.yaml app_name â†’ {app_name}')
              # lib/common/constant.dartï¼ˆåº”ç”¨å†…åç§°ã€çª—å£æ ‡é¢˜ï¼‰
              p = Path('lib/common/constant.dart')
              if p.exists():
                  txt = p.read_text(encoding='utf-8')
                  txt = re.sub(r'(const appName\s*=\s*")[^"]*(")', rf'\g<1>{app_name}\g<2>', txt)
                  txt = re.sub(r'(const appNameEn\s*=\s*")[^"]*(")', rf'\g<1>{app_name}\g<2>', txt)
                  p.write_text(txt, encoding='utf-8')
                  print(f'[inject] constant.dart appName â†’ {app_name}')

          # â”€â”€ 3. æ›¿æ¢ç‰ˆæœ¬å· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ver = env('APP_VERSION')
          if ver:
              p = Path('pubspec.yaml')
              txt = p.read_text()
              # åªæ›¿æ¢ major.minor.patchï¼Œä¿ç•™ +buildNumber
              txt = re.sub(r'^(version:\s*)[\d.]+(\+)', rf'\g<1>{ver}\2',
                           txt, flags=re.MULTILINE)
              p.write_text(txt)
              print(f'[inject] pubspec version â†’ {ver}')

          # â”€â”€ 4. æ›¿æ¢åº”ç”¨å›¾æ ‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          logo_url = env('APP_LOGO_URL')
          if logo_url:
              try:
                  import glob as _glob, json as _json
                  from PIL import Image

                  # ä¸‹è½½å›¾ç‰‡ï¼ˆå¸¦ User-Agentï¼Œæ”¯æŒé‡å®šå‘ï¼‰
                  req = urllib.request.Request(logo_url, headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req, timeout=30) as r:
                      img = Image.open(io.BytesIO(r.read())).convert('RGBA')
                  print(f'[inject] Logo ä¸‹è½½æˆåŠŸ: {img.size}')

                  # â”€â”€ Android mipmap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  for folder, size in {
                      'mipmap-mdpi': 48, 'mipmap-hdpi': 72,
                      'mipmap-xhdpi': 96, 'mipmap-xxhdpi': 144,
                      'mipmap-xxxhdpi': 192,
                  }.items():
                      base = Path(f'android/app/src/main/res/{folder}')
                      if not base.exists():
                          continue
                      ri = img.resize((size, size), Image.LANCZOS)
                      replaced = False
                      for stem in ['ic_launcher', 'ic_launcher_round']:
                          for ext, fmt in [('webp', 'WEBP'), ('png', 'PNG')]:
                              f = base / f'{stem}.{ext}'
                              if f.exists():
                                  ri.save(f, format=fmt)
                                  print(f'[inject] Android icon: {f}')
                                  replaced = True
                      if not replaced:
                          ri.save(base / 'ic_launcher.webp', format='WEBP')
                          print(f'[inject] Android icon (æ–°å»º): {base}/ic_launcher.webp')

                  # åˆ é™¤ adaptive icon XMLï¼ˆè®©ç³»ç»Ÿå›é€€åˆ°ä½å›¾ï¼‰
                  for xml_f in _glob.glob('android/app/src/main/res/mipmap-anydpi*/ic_launcher*.xml'):
                      Path(xml_f).unlink()
                      print(f'[inject] åˆ é™¤ adaptive XML: {xml_f}')

                  # Android Google Play å°é¢å›¾
                  ps = Path('android/app/src/main/ic_launcher-playstore.png')
                  if ps.exists():
                      img.resize((512, 512), Image.LANCZOS).save(ps)
                      print(f'[inject] Android playstore icon: {ps}')

                  # â”€â”€ Windows ICO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  # æ­£ç¡®ç”¨æ³•ï¼šç›´æ¥ä¼  sizesï¼Œè®© Pillow è‡ªåŠ¨ä»åŸå›¾é«˜è´¨é‡ç¼©æ”¾
                  ico = Path('windows/runner/resources/app_icon.ico')
                  if ico.parent.exists():
                      img.save(str(ico), format='ICO',
                               sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])
                      print(f'[inject] Windows ICO (6 å°ºå¯¸): {ico}')

                  # â”€â”€ macOS appiconset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  # ç”¨ Contents.json é‡Œçš„ size/scale å­—æ®µè®¡ç®—åƒç´ å°ºå¯¸ï¼Œä¸ä¾èµ–æ–‡ä»¶åæ ¼å¼
                  appiconset = Path('macos/Runner/Assets.xcassets/AppIcon.appiconset')
                  if appiconset.exists():
                      contents_file = appiconset / 'Contents.json'
                      if contents_file.exists():
                          data = _json.loads(contents_file.read_text())
                          processed = set()
                          for item in data.get('images', []):
                              fname = item.get('filename', '')
                              if not fname or fname in processed:
                                  continue
                              processed.add(fname)
                              size_str  = item.get('size', '')    # e.g. "16x16"
                              scale_str = item.get('scale', '1x') # e.g. "2x"
                              try:
                                  base_px = int(size_str.split('x')[0])
                                  scale   = int(scale_str.rstrip('x'))
                                  px = base_px * scale
                                  img.resize((px, px), Image.LANCZOS).save(appiconset / fname)
                                  print(f'[inject] macOS icon: {fname} ({px}x{px})')
                              except Exception as ex:
                                  print(f'[inject] âš ï¸  macOS icon {fname} è·³è¿‡: {ex}')
                      print(f'[inject] macOS å›¾æ ‡æ›¿æ¢å®Œæˆ')

                  # â”€â”€ assets/images/ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                  assets_img = Path('assets/images')
                  if assets_img.exists():
                      img_1024 = img.resize((1024, 1024), Image.LANCZOS)
                      for name in ['icon.png', 'icon_black.png', 'icon_white.png']:
                          p = assets_img / name
                          if p.exists():
                              img_1024.save(p)
                              print(f'[inject] assets/images: {p}')
                      for name in ['icon.ico', 'icon_black.ico', 'icon_white.ico']:
                          p = assets_img / name
                          if p.exists():
                              img.save(str(p), format='ICO',
                                       sizes=[(16,16),(32,32),(48,48),(64,64),(128,128),(256,256)])
                              print(f'[inject] assets/images ICO: {p}')

                  print(f'[inject] âœ… å›¾æ ‡æ›¿æ¢å…¨éƒ¨å®Œæˆ')
              except Exception as e:
                  import traceback
                  print(f'[inject] âš ï¸  å›¾æ ‡æ›¿æ¢å¤±è´¥ï¼ˆè·³è¿‡ï¼‰: {e}')
                  traceback.print_exc()

          PYEOF

      # â”€â”€ 3. Android ç­¾åé…ç½®ï¼ˆå¯é€‰ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Android signing
        if: matrix.platform == 'android'
        env:
          KEYSTORE:       ${{ secrets.KEYSTORE }}
          KEY_ALIAS:      ${{ secrets.KEY_ALIAS }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD:   ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE" ]; then
            echo "$KEYSTORE" | base64 --decode > android/app/keystore.jks
            echo "keyAlias=$KEY_ALIAS"           >> android/local.properties
            echo "storePassword=$STORE_PASSWORD" >> android/local.properties
            echo "keyPassword=$KEY_PASSWORD"     >> android/local.properties
          fi

      # â”€â”€ 4. Windows æ„å»ºä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Windows build environment
        if: matrix.platform == 'windows'
        run: |
          if ! command -v jq &>/dev/null; then
            choco install jq -y --no-progress && \
              echo "/c/ProgramData/chocolatey/bin" >> $GITHUB_PATH || true
          fi
          if ! command -v cargo &>/dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source "$HOME/.cargo/env"
            echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          fi
          cargo --version
          ATL_GLOB="/c/Program Files (x86)/Microsoft Visual Studio/2022/BuildTools/VC/Tools/MSVC/*/atlmfc/include/atlstr.h"
          if ! ls $ATL_GLOB 1>/dev/null 2>&1; then
            choco install visualstudio2022buildtools \
              --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools \
                --add Microsoft.VisualStudio.Component.VC.ATL \
                --add Microsoft.VisualStudio.Component.VC.ATLMFC \
                --includeRecommended --quiet" \
              -y --force || true
          fi
          INNO_EXE="/c/Program Files (x86)/Inno Setup 6/ISCC.exe"
          if [ ! -f "$INNO_EXE" ]; then
            choco install innosetup -y --no-progress
          fi
          echo "/c/Program Files (x86)/Inno Setup 6" >> $GITHUB_PATH

      # â”€â”€ 5. macOSï¼šæ¸…é™¤ SPM æ„å»ºç¼“å­˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Clean macOS SPM cache
        if: matrix.platform == 'macos'
        run: |
          rm -rf macos/Runner.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/
          rm -rf macos/Runner.xcworkspace/xcshareddata/swiftpm/

      # â”€â”€ 6. å®‰è£… Go â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Go
        if: github.event_name == 'push' || inputs.platforms == '' || contains(inputs.platforms, matrix.platform)
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: false

      # â”€â”€ 7. å®‰è£… Flutter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Flutter
        if: github.event_name == 'push' || inputs.platforms == '' || contains(inputs.platforms, matrix.platform)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # â”€â”€ 8. Windows: å®‰è£… flutter_distributor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup flutter_distributor (Windows)
        if: matrix.platform == 'windows'
        run: |
          PUB_BIN="/c/Users/$(whoami)/AppData/Local/Pub/Cache/bin"
          echo "$PUB_BIN" >> $GITHUB_PATH
          dart pub global activate flutter_distributor

      # â”€â”€ 9. å®‰è£…é¡¹ç›®ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        if: github.event_name == 'push' || inputs.platforms == '' || contains(inputs.platforms, matrix.platform)
        run: flutter pub get

      # â”€â”€ 10. ç”Ÿæˆ SDK ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate SDK code
        if: github.event_name == 'push' || inputs.platforms == '' || contains(inputs.platforms, matrix.platform)
        run: |
          cd lib/sdk/flutter_xboard_sdk
          flutter pub get
          dart run build_runner build --delete-conflicting-outputs
          cd ../../..

      # â”€â”€ 11. ç”Ÿæˆä¸»é¡¹ç›®ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate project code
        if: github.event_name == 'push' || inputs.platforms == '' || contains(inputs.platforms, matrix.platform)
        run: dart run build_runner build --delete-conflicting-outputs

      # â”€â”€ 12. ç¼–è¯‘æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build
        # matrix ä¸Šä¸‹æ–‡ä»…åœ¨ step çº§å¯ç”¨ï¼Œjob çº§ if ä¸æ”¯æŒï¼ˆ422 é”™è¯¯ï¼‰
        if: |
          github.event_name == 'push' ||
          inputs.platforms == '' ||
          contains(inputs.platforms, matrix.platform)
        run: |
          dart setup.dart ${{ matrix.platform }} \
            ${{ matrix.arch && format('--arch {0}', matrix.arch) || '' }} \
            ${{ env.IS_STABLE == 'true' && '--env stable' || '' }}

      # â”€â”€ 13. æ„å»ºç»“æœè¯Šæ–­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Debug dist output
        if: always()
        run: |
          echo "=== dist/ contents ==="
          ls -la dist/ 2>/dev/null || echo "[dist/ not found]"

      # â”€â”€ 14. ä¸Šä¼ æ„å»ºäº§ç‰© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload artifact
        if: |
          github.event_name == 'push' ||
          inputs.platforms == '' ||
          contains(inputs.platforms, matrix.platform)
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) || '' }}
          path: ./dist
          overwrite: true

      # â”€â”€ 15. æ„å»ºå®Œæˆï¼šé€šè¿‡ TG å‘åŒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ä»… workflow_dispatch ä¸”é…ç½®äº† notify_chat_id æ—¶è§¦å‘
      - name: Notify and send artifacts to Telegram
        if: |
          always() &&
          github.event_name == 'workflow_dispatch' &&
          inputs.notify_chat_id != '' &&
          (inputs.platforms == '' || contains(inputs.platforms, matrix.platform))
        env:
          BOT_TOKEN:  ${{ secrets.BUILD_BOT_TOKEN }}
          CHAT_ID:    ${{ inputs.notify_chat_id }}
          PLATFORM:   ${{ matrix.platform }}
          ARCH:       ${{ matrix.arch }}
          RUN_URL:    ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          JOB_STATUS: ${{ job.status }}
        run: |
          [ -z "$BOT_TOKEN" ] && echo "[notify] BUILD_BOT_TOKEN æœªé…ç½®ï¼Œè·³è¿‡" && exit 0

          # å‹å¥½å¹³å°åç§°æ˜ å°„
          case "${PLATFORM}-${ARCH}" in
            android-)      LABEL="Android" ;;
            windows-amd64) LABEL="Windows (x64)" ;;
            macos-arm64)   LABEL="macOS (Apple Silicon)" ;;
            macos-amd64)   LABEL="macOS (Intel)" ;;
            linux-amd64)   LABEL="Linux (x64)" ;;
            *)             LABEL="${PLATFORM}${ARCH:+-${ARCH}}" ;;
          esac

          # å‘é€çŠ¶æ€é€šçŸ¥
          if [ "$JOB_STATUS" = "success" ]; then
            MSG="âœ… *${LABEL}* æ„å»ºå®Œæˆ"
          else
            MSG="âŒ *${LABEL}* æ„å»ºå¤±è´¥ â€” [æŸ¥çœ‹æ—¥å¿—](${RUN_URL})"
          fi

          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=${MSG}" \
            -d "parse_mode=Markdown" || true

          # æˆåŠŸæ—¶é€æ–‡ä»¶å‘é€ï¼ˆè·³è¿‡ .sha256 ç­‰æ ¡éªŒæ–‡ä»¶ï¼‰
          if [ "$JOB_STATUS" = "success" ]; then
            find dist/ -type f ! -name "*.sha256" | while read -r f; do
              SIZE=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null || echo 0)
              if [ "$SIZE" -le 52428800 ]; then   # â‰¤50MBï¼šç›´æ¥å‘æ–‡ä»¶
                curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
                  -F "chat_id=${CHAT_ID}" \
                  -F "document=@${f}" \
                  -F "caption=ğŸ“¦ $(basename ${f})" || true
              else                                  # >50MBï¼šå‘ä¸‹è½½é“¾æ¥
                curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
                  -d "chat_id=${CHAT_ID}" \
                  -d "text=ğŸ“¦ $(basename ${f}) ($(( SIZE/1024/1024 ))MB) è¶…å‡º TG é™åˆ¶ï¼Œè¯·åˆ° [Actions](${RUN_URL}) ä¸‹è½½" \
                  -d "parse_mode=Markdown" || true
              fi
            done
          fi

  # â”€â”€ Releaseï¼šæ‰“ tag æ—¶è‡ªåŠ¨å‘å¸ƒåˆ°æœ¬å…¬å…±ä»“åº“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist/
          pattern: artifact-*
          merge-multiple: true

      - name: Generate SHA256 checksums
        run: |
          cd ./dist
          for file in $(find . -type f -not -name "*.sha256"); do
            sha256sum "$file" > "${file}.sha256"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/*
          generate_release_notes: true
